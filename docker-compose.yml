version: '3.8'

services:
  # File Server - Hosts uploaded files with chunked upload support
  file-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: discord-file-server
    restart: unless-stopped
    ports:
      - "51424:51424"
    environment:
      - PORT=51424
      - API_KEY=${API_KEY}
      - DOMAIN=${FILE_SERVER_URL}
      - NODE_ENV=production
      - FILE_RETENTION_DAYS=${FILE_RETENTION_DAYS:-30}
      - NODE_OPTIONS=--max-old-space-size=4096 --max-http-header-size=16384
    volumes:
      - /mnt/spare-nvme/discord-uploader-volumes/uploads:/app/uploads
      - /mnt/spare-nvme/discord-uploader-volumes/chunks:/app/chunks
      - ./server/server.js:/app/server.js:ro
      - ./server/package.json:/app/package.json:ro
    networks:
      - discord-network
    deploy:
      resources:
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:51424/health"]
      interval: 20s
      timeout: 5s
      retries: 2
      start_period: 120s

  # Discord Bot - Processes uploads with chunked support
  discord-bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    container_name: discord-upload-bot
    restart: unless-stopped
    ports:
      - "8458:8458"
    environment:
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - FILE_SERVER_URL=http://file-server:51424
      - FILE_SERVER_API_KEY=${API_KEY}
      - UPLOAD_PORT=8458
      - PUBLIC_UPLOAD_URL=${PUBLIC_UPLOAD_URL}
      - MONITORED_CHANNELS=${MONITORED_CHANNELS:-}
      - MONITORED_USERS=${MONITORED_USERS:-}
      - DELETE_ORIGINAL=${DELETE_ORIGINAL:-false}
      - ADD_REACTION=${ADD_REACTION:-true}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-5000}
      - NODE_OPTIONS=--max-old-space-size=4096 --max-http-header-size=16384
    volumes:
      - /mnt/spare-nvme/discord-uploader-volumes/bot-temp:/app/temp
      - /mnt/spare-nvme/discord-uploader-volumes/direct-uploads:/app/direct-uploads
      - ./bot/bot.js:/app/bot.js:ro
      - ./bot/bot.js:/app/bot.js
    networks:
      - discord-network
    depends_on:
      file-server:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8458/health"]
      interval: 20s
      timeout: 5s
      retries: 2
      start_period: 120s

  # Apache Reverse Proxy - Runs alongside Nextcloud
  apache-proxy:
    image: httpd:2.4
    container_name: discord-apache-proxy
    restart: unless-stopped
    ports:
      - "8880:80"
      - "8443:443"
    volumes:
      - ./apache-discord-files.conf:/usr/local/apache2/conf/extra/discord-files.conf:ro
      - ./ssl:/usr/local/apache2/conf/ssl:ro
      - ./apache/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro
    networks:
      - discord-network
    depends_on:
      file-server:
        condition: service_healthy
    deploy:
      resources:
        reservations:
          memory: 512M

networks:
  discord-network:
    driver: bridge
    name: discord-network

volumes:
  uploads:
    name: discord-uploads
  chunks:
    name: discord-chunks
  bot-temp:
    name: discord-bot-temp
  direct-uploads:
    name: discord-direct-uploads