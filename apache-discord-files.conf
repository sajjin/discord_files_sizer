<VirtualHost *:80>
    ServerName aksfarmserver.com
    ServerAlias *.aksfarmserver.com

    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

# HTTPS - files.domain subdomain (File Server)
<VirtualHost *:443>
    ServerName files.aksfarmserver.com

    # SSL Configuration - Mount certificates to /usr/local/apache2/conf/ssl/
    SSLEngine on
    SSLCertificateFile /usr/local/apache2/conf/ssl/aksfarmserver.com/fullchain.pem
    SSLCertificateKeyFile /usr/local/apache2/conf/ssl/aksfarmserver.com/privkey.pem

    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "no-referrer-when-downgrade"

    # Logging
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined

    # Enable proxy modules
    ProxyPreserveHost On
    ProxyRequests Off

    # Increase timeout for large file uploads (10 minutes)
    ProxyTimeout 600
    TimeOut 600

    # File Server - Use Docker internal DNS to reach file-server container
    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://file-server:51424/$1 [P,L]
    
    # Proxy all other requests
    ProxyPass / http://file-server:51424/
    ProxyPassReverse / http://file-server:51424/

    # Allow large file uploads
    LimitRequestBody 10737418240
    
    # Enable Keep-Alive for better performance
    KeepAlive On
    MaxKeepAliveRequests 1000
    KeepAliveTimeout 600

    <Location />
        # Allow all requests
        Require all granted
    </Location>
</VirtualHost>

# HTTPS - uploads.domain subdomain (Discord Bot Upload Handler)
<VirtualHost *:443>
    ServerName uploads.aksfarmserver.com

    # SSL Configuration - Mount certificates to /usr/local/apache2/conf/ssl/
    SSLEngine on
    SSLCertificateFile /usr/local/apache2/conf/ssl/aksfarmserver.com/fullchain.pem
    SSLCertificateKeyFile /usr/local/apache2/conf/ssl/aksfarmserver.com/privkey.pem

    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "no-referrer-when-downgrade"

    # Logging
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined

    # Enable proxy modules
    ProxyPreserveHost On
    ProxyRequests Off

    # Increase timeout for large file uploads (10 minutes)
    ProxyTimeout 600
    TimeOut 600

    # Discord Bot Upload Handler - Use Docker internal DNS
    ProxyPass / http://discord-bot:8458/
    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://discord-bot:8458/$1 [P,L]
    
    # Proxy all other requests
    ProxyPass / http://discord-bot:8458/
    ProxyPassReverse / http://discord-bot:8458/
    # Allow large file uploads
    LimitRequestBody 10737418240
    
    # Enable Keep-Alive for better performance
    KeepAlive On
    MaxKeepAliveRequests 1000
    KeepAliveTimeout 600

    <Location />
        # Allow all requests
        Require all granted
    </Location>
</VirtualHost>
